<!DOCTYPE html>
<html>
    <head>
        <title>EU Transparency Register</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
        <script src='http://code.jquery.com/jquery-1.11.0.min.js' type="text/javascript"></script>
        <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>

        <style>

          #map {
            width: 600px;
            height: 600px;
          }

          .info {
            padding: 6px 12px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
          }

          .info h4 {
            margin: 0 0 5px;
            color: #777;
          }

          .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
          }

          .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 21px;
            opacity: 0.7;
          }

          select { text-indent: 30px; }

        </style>
    </head>

    <body>
        <div id="map_container">
          <div id='map'></div>
        </div>
        <div style="position:absolute; top:10px; left:615px; text-align:left; font: 14px/16px Arial, Helvetica, sans-serif;">
          <div style="width:183px; text-align:center;">
            <span style="font-weight:bold;">Select a NUTS level:</span>
            <select onchange="selectNuts(this)" style="width:183px;">
              <option value="nuts0_data">NUTS 0</option>
              <option value="nuts1_data">NUTS 1</option>
              <option value="nuts2_data">NUTS 2</option>
              <option value="nuts3_data">NUTS 3</option>
            </select>
            <h3 id="list-header"></h3>
          </div>
          <div id="list" style="height:508px; overflow-y:scroll; width:200px;"><div>
        </div>

        <script type="text/javascript" src="../datasets/languages.js"></script>
        <script type="text/javascript" src="../datasets/TEDdata.js"></script>
        <script type="text/javascript" src="../datasets/nuts_0.js"></script>
        <script type="text/javascript" src="../datasets/nuts_1.js"></script>
        <script type="text/javascript" src="../datasets/nuts_2.js"></script>
        <script type="text/javascript" src="../datasets/nuts_3.js"></script>
        <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>
        <script type="text/javascript">

          var userLang = navigator.language || navigator.userLanguage;
          if(!texts[userLang]){
            userLang = 'en-US';
          }
          $('#list-header').text(texts[userLang].tList);

          drawMap(nuts0_data);

          function selectNuts(option) {
            drawMap(window[option.value]);
          }

          function drawMap(statesData){

              var myNode = document.getElementById("map_container");
              while (myNode.firstChild) {
                myNode.removeChild(myNode.firstChild);
              }
              $("#map_container").append("<div id='map'></div>");

              var map = L.map('map').setView([52, 15], 4);

              L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                  maxZoom: 18,
                  id: 'mapbox.light'
              }).addTo(map);
              var layer = L.esri.basemapLayer('Gray').addTo(map);


               // control that shows state info on hover
              var info = L.control();

              info.onAdd = function (map) {
                  this._div = L.DomUtil.create('div', 'info');
                  this.update();
                  return this._div;
              };

              info.update = function (props) {
                  console.log(props);
                  var nbrTenders;
                  if(props) {
                    if(TEDdata[props.NUTS_ID] == undefined){
                      nbrTenders = 0;
                    } else {
                      nbrTenders = TEDdata[props.NUTS_ID].length;
                    }
                  }
                  this._div.innerHTML = (props ?
                      '<b>' + props.NUTS_ID + '</b><br />' + texts[userLang].nTenders + nbrTenders
                      : texts[userLang].hover);
              };

              info.addTo(map);


              // get color depending on value
              function getColor(d) {
                  return  d > 20  ? '#145FAB' :
                          d > 10  ? '#0092C2' :
                          d > 5   ? '#47B5C0' :
                          d > 2   ? '#80CCBA' :
                          d > 1   ? '#C5E9B0' :
                                    '#0092C2';
              }

              function style(feature) {
                  return {
                      weight: 1,
                      opacity: 1,
                      color: 'white',
                      fillOpacity: 1,
              /* fillColor: getColor(feature.properties.density)*/
                  };
              }

              function highlightFeature(e) {
                  var layer = e.target;

                  layer.setStyle({
                      fillOpacity: 0.7
                  });

                  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                      layer.bringToFront();
                  }

               info.update(layer.feature.properties);
              }

              function setColors(value) {
                  value = -1;//TODO color depending on the number of tenders
                  geojson.eachLayer(function(layer) {
                      layer.setStyle({
                          fillColor: getColor(layer.feature.properties[value])
                      });
                  });
              }

              var geojson;

              function resetHighlight(e) {
                  var layer = e.target;

                  layer.setStyle({
                      fillOpacity: 1
                  });

                  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                      layer.bringToBack();
                  }

               info.update();
              }

              function zoomToFeature(e) {
                  map.fitBounds(e.target.getBounds());
              }

              function onEachFeature(feature, layer) {
                  layer.on({
                      mouseover: highlightFeature,
                      mouseout: resetHighlight,
                      click: updatePanel
                  });
              }

              geojson = L.geoJson(statesData, {
                  style: style,
                  onEachFeature: onEachFeature
              }).addTo(map);


              function updatePanel(e){
                var myNode = document.getElementById("list");
                while (myNode.firstChild) {
                  myNode.removeChild(myNode.firstChild);
                }
                if(TEDdata[e.target.feature.properties.NUTS_ID] == undefined){
                  $('#list').append('<h5 style="text-align:center;">'+texts[userLang].noTenders+'</h5>');
                }
                else {
                  TEDdata[e.target.feature.properties.NUTS_ID].forEach(function(t){
                    var url = "http://ted.europa.eu/udl?uri=TED:NOTICE:" + t + ":TEXT:EN:HTML";
                    $('#list').append('<div style="border-bottom: 0.5px solid grey; text-align:center;"><a target="_blank" href='+url+'>'+t+'</a></div>');
                  });
                }
              }

              setColors();


              /*var legend = L.control({position: 'bottomright'});

              legend.onAdd = function (map) {

                  var div = L.DomUtil.create('div', 'info legend'),
                      grades = [0, 1, 2, 5, 10, 20],
                      labels = [],
                      from, to;

                  for (var i = 0; i < grades.length; i++) {
                      from = grades[i];
                      to = grades[i + 1];

                      labels.push(
                          '<i style="background:' + getColor(from + 1) + '"></i> ' +
                          from + (to ? '&ndash;' + to : '+'));
                  }

                  div.innerHTML = labels.join('<br>');
                  return div;
              };

              legend.addTo(map);*/
          }
        </script>
    </body>
</html>
